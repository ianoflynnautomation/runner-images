name: Build and Release Images

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: "Version override (e.g., 2.1.0)"
        required: false
        type: string
      image_os:
        description: "Specific OS to build"
        required: false
        type: choice
        options:
          - all
          - ubuntu22
          - ubuntu24
        default: ubuntu24

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write

env:
  LOCATION: switzerlandnorth
  PACKER_VERSION: "1.14.3"
  GALLERY_NAME: "sigghaimagesswn"
  TEMPLATE_PATH: images/ubuntu/templates/

jobs:
  version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version:         ${{ steps.calver.outputs.version }}
      version_tag:     ${{ steps.calver.outputs.version_tag }}
      build_date:      ${{ steps.calver.outputs.build_date }}
      image_age_days:  ${{ steps.calver.outputs.image_age_days }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Generate Calender Version
        id: calver
        shell: pwsh
        run: |
          ./helpers/GetCalenderVersion.ps1 `
            -VersionOverride "${{ inputs.version_override }}"

  build-image:
    name: Build ${{ matrix.name }}
    needs: version
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          # - image_os: ubuntu22
          #   os_version: "22_04"
          #   image_definition: "github-runner-ubuntu-2204"
          #   name: "Ubuntu 22.04 LTS"
          #   base_sku: "22_04-lts-gen2"
          #   agent_spec: "ubuntu-22.04"
          - image_os: ubuntu24
            os_version: "24_04"
            image_definition: "github-runner-ubuntu-2404"
            name: "Ubuntu 24.04 LTS"
            base_sku: "24_04-lts-gen2"
            agent_spec: "ubuntu-24.04"

    env:
      IMAGE_VERSION: ${{ needs.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Verify Packer installation
        run: packer version

      - name: Install Packer Azure Plugin
        run: packer plugins install github.com/hashicorp/azure

      - name: Cache Packer Plugins
        uses: actions/cache@v4
        with:
          path: ~/.packer.d/plugins
          key: ${{ runner.os }}-packer-${{ hashFiles('**/*.pkr.hcl') }}
          restore-keys: |
            ${{ runner.os }}-packer-

      - name: Format Packer
        run: |
          packer fmt -check ${{ env.TEMPLATE_PATH }} || packer fmt ${{ env.TEMPLATE_PATH }}

      - name: Initialize Packer
        run: |
          packer init ${{ env.TEMPLATE_PATH }}

      - name: Validate Packer Template
        run: |
          packer validate -syntax-only ${{ env.TEMPLATE_PATH }}

      - name: Build Image with Packer
        run: |
          echo "Building ${{ matrix.image_definition }} (Ubuntu ${{ matrix.os_version }}) Version $IMAGE_VERSION"

          packer build \
            # -only="${{ needs.version.outputs.version }}" \
            -var="client_id=${{ secrets.AZURE_CLIENT_ID }}" \
            -var="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="oidc_request_token=$ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            -var="oidc_request_url=$ACTIONS_ID_TOKEN_REQUEST_URL" \
            # -var="managed_image_name=${{ matrix.image_definition }}" \
            # -var="managed_image_resource_group_name=${{ secrets.IMAGE_RESOURCE_GROUP }}" \
            -var="image_os=${{ matrix.image_os }}" \
            -var="build_resource_group_name=${{ secrets.BUILD_RG_NAME }}" \
            -var="gallery_name=${{ env.GALLERY_NAME }}" \
            -var="gallery_resource_group_name=${{ secrets.IMAGE_RESOURCE_GROUP }}" \
            -var="gallery_image_name=${{ matrix.image_definition }}" \
            -var="gallery_image_version=${{ needs.version.outputs.version }}" \
            -color=false \
            ${{ env.TEMPLATE_PATH }}
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: packerlog.txt

      - name: Display Packer Logs on Failure
        if: failure()
        run: cat packerlog.txt

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.image_os }}-${{ env.IMAGE_VERSION }}
          path: packerlog.txt
          retention-days: 30
